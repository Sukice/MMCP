<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMCP æ§åˆ¶å°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --primary-color: #67C23A; --bg-color: #f2f4f7; --card-bg: #ffffff; --text-main: #2c3e50; }
        body, html { background-color: var(--bg-color); margin: 0; height: 100%; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; color: var(--text-main); }
        #app { height: 100vh; display: flex; flex-direction: column; }

        /* Header & Layout */
        .header-bar { height: 56px; background: #fff; border-bottom: 1px solid #ebeef5; display: flex; align-items: center; padding: 0 24px; justify-content: space-between; box-shadow: 0 1px 4px rgba(0,0,0,0.03); z-index: 10; }
        .app-title { font-weight: 600; font-size: 18px; display: flex; align-items: center; gap: 12px; }
        .main-container { flex: 1; display: flex; overflow: hidden; padding: 16px; gap: 16px; }
        .left-panel { width: 300px; display: flex; flex-direction: column; gap: 16px; }
        .center-panel { flex: 1; background: var(--card-bg); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #ebeef5; }
        .right-panel { width: 340px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; }

        /* Cards & Lists */
        .panel-card { background: var(--card-bg); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #ebeef5; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .panel-header { padding: 12px 16px; border-bottom: 1px solid #f0f2f5; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; background: #fbfbfc; }
        .scrollable-content { flex: 1; overflow-y: auto; padding: 0; }
        .list-item { padding: 12px 16px; border-bottom: 1px solid #f5f7fa; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { background-color: #f5f9ff; padding-left: 20px; }

        /* æ’ä»¶æ›´å¤šæŒ‰é’®åŠ¨ç”» */
        .plugin-more-btn { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #909399; transition: all 0.3s; }
        .plugin-more-btn:hover { background-color: #ecf5ff; color: var(--primary-color); animation: wiggle 0.6s ease-in-out infinite; }
        @keyframes wiggle { 0%, 100% { transform: rotate(0deg) scale(1.1); } 25% { transform: rotate(-15deg) scale(1.1); } 75% { transform: rotate(15deg) scale(1.1); } }

        /* è¯¦æƒ…é¡µæ ·å¼ */
        .func-item { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; }
        .func-name { font-family: monospace; font-weight: 600; color: #409EFF; font-size: 14px; }
        .func-desc { font-size: 12px; color: #606266; margin: 4px 0 8px; }
        .param-tag { font-family: monospace; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-right: 6px; border: 1px solid; transition: all 0.2s; cursor: default; }
        .param-tag.is-required { background: #fef0f0; border-color: #ffcccc; color: #f56c6c; font-weight: 600; }
        .param-tag.is-optional { background: #f4f4f5; border-color: #e9e9eb; color: #909399; }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-drop-zone { border: 2px dashed #dcdfe6; border-radius: 8px; text-align: center; padding: 40px 0; cursor: pointer; transition: all 0.3s; background-color: #fafafa; }
        .upload-drop-zone:hover { border-color: var(--primary-color); background-color: #f0f9eb; }
        .upload-icon { font-size: 48px; color: #909399; margin-bottom: 10px; transition: color 0.3s; }
        .upload-drop-zone:hover .upload-icon { color: var(--primary-color); }
        .upload-text { font-size: 14px; color: #606266; }
        .upload-tips { margin-top: 20px; padding: 15px; background: #fef0f0; border-radius: 6px; color: #f56c6c; font-size: 12px; }

        /* Logs */
        .log-container { font-family: "JetBrains Mono", "Segoe UI Emoji", monospace; font-size: 13px; line-height: 1.6; padding: 20px; }
        .log-item { margin-bottom: 12px; padding-left: 14px; border-left: 3px solid #ddd; animation: slideIn 0.3s; word-wrap: break-word; }
        .log-reasoning { border-color: #E6A23C; color: #b7791f; background: #fffdf5; padding: 8px 12px; border-radius: 0 6px 6px 0; white-space: pre-wrap; }
        .log-tool-call { border-color: #409EFF; color: #0958d9; }
        .log-tool-result { border-color: #409EFF; color: #5c6b7f; font-style: italic; background: #f0f5ff; padding: 6px 12px; border-radius: 0 6px 6px 0; display: block; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }

        /* Markdown å“åº”åŒºåŸŸæ ·å¼ */
        .log-response { border-left: 4px solid #9c27b0; background: linear-gradient(to right, #fbf5ff, #fff); padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; color: #2c3e50; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; overflow-x: auto; }
        .log-response p { margin-bottom: 10px; line-height: 1.6; }
        .log-response pre { background: #f6f8fa; padding: 12px; border-radius: 6px; overflow-x: auto; }
        .log-response code { background: #f0f0f0; padding: 2px 4px; border-radius: 4px; font-family: monospace; color: #d63384; }
        .log-response img { max-width: 100%; border-radius: 4px; margin: 10px 0; }
        .log-response table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .log-response th, .log-response td { border: 1px solid #dfe2e5; padding: 6px 13px; }
        .log-response tr:nth-child(2n) { background-color: #f6f8fa; }

        /* Task Dialog Layout */
        .task-dialog-layout { display: flex; height: 380px; gap: 20px; }
        .task-form-col { flex: 1; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 10px; }
        .task-tool-col { width: 300px; border-left: 1px solid #eee; padding-left: 20px; display: flex; flex-direction: column; }

        /* Tool Tree */
        .tool-tree-header { font-weight: 600; font-size: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .tool-tree-container { flex: 1; overflow-y: auto; border: 1px solid #ebeef5; border-radius: 6px; padding: 10px; background: #fdfdfd; }
        .plugin-node { margin-bottom: 10px; }
        .plugin-node-header { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; }
        .plugin-checkbox { font-weight: 600; font-family: monospace; color: #333; }
        .func-node-list { margin-left: 24px; margin-top: 5px; border-left: 2px solid #f0f0f0; padding-left: 10px; }
        .func-checkbox { font-size: 13px; color: #606266; margin-bottom: 4px; display: block; font-family: monospace; }
        .toggle-btn { cursor: pointer; color: #909399; transition: transform 0.2s; font-size: 12px; padding: 2px;}
        .toggle-btn:hover { color: var(--primary-color); }
        .toggle-btn.is-open { transform: rotate(180deg); }

        /* Tabs */
        .el-tabs { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .el-tabs__content { flex: 1; overflow: hidden; padding: 0 !important; }
        .el-tabs__header { margin: 0 !important; background: #f5f7fa; border-bottom: 1px solid #e4e7ed; }
        .el-tab-pane { height: 100%; overflow-y: auto; padding: 24px; background: #fff; }

        /* Model List Item */
        .model-item-wrapper { position: relative; overflow: hidden; border-bottom: 1px solid #f5f7fa; cursor: pointer; background: #fff; }
        .model-content { padding: 12px 16px; background: #fff; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1); position: relative; z-index: 2; }
        .model-content.is-slid { transform: translateX(-60px); }
        .model-delete-btn { position: absolute; top: 0; right: 0; bottom: 0; width: 60px; background-color: #F56C6C; display: flex; align-items: center; justify-content: center; color: white; z-index: 1; cursor: pointer; transition: background 0.2s; }
        .model-delete-btn:hover { background-color: #ff4949; }

        /* Attachments */
        .attachment-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .attachment-tag { display: flex; align-items: center; background: #f0f9eb; color: #67C23A; border: 1px solid #e1f3d8; border-radius: 16px; padding: 4px 10px; font-size: 12px; cursor: default; transition: all 0.2s; }
        .attachment-tag:hover { background-color: #e1f3d8; }
        .attachment-tag .el-icon { margin-right: 4px; }
        .attachment-remove { margin-left: 6px; cursor: pointer; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .attachment-remove:hover { background-color: rgba(0,0,0,0.1); color: #F56C6C; }

        .upload-trigger-btn { cursor: pointer; color: #909399; transition: color 0.2s; margin-right: 10px; display: flex; align-items: center; }
        .upload-trigger-btn:hover { color: var(--primary-color); }
        .upload-trigger-btn.is-disabled { color: #c0c4cc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="app" @click="handleGlobalClick">
        <div class="header-bar">
            <div class="app-title"><div style="width:10px; height:10px; background:linear-gradient(135deg, #67C23A, #95d475); border-radius:50%; box-shadow: 0 0 8px rgba(103,194,58,0.4);"></div>MMCP Dashboard</div>
            <div style="font-size: 13px; color: #8492a6; font-family: monospace;">{{ currentTime }}</div>
        </div>

        <div class="main-container">
            <div class="left-panel">
                <div class="panel-card" style="flex:1;">
                    <div class="panel-header"><span>ä»»åŠ¡é˜Ÿåˆ— <el-tag size="small" type="info" round effect="plain">{{ taskList.length }}</el-tag></span><el-button type="primary" link icon="Plus" @click.stop="showAddDialog"></el-button></div>
                    <div class="scrollable-content">
                        <div v-for="(task, index) in taskList" :key="task.task_id" class="list-item" @dblclick="openTaskTab(task)">
                            <div style="display:flex; justify-content:space-between; margin-bottom:6px; align-items: center;"><span style="font-weight:600; font-size: 14px; color: #303133;">#{{index+1}} {{truncate(task.task_name, 12)}}</span><el-tag size="small" :type="task.status_display === 'Handling' ? 'warning' : 'info'" effect="light" round>{{task.status_display}}</el-tag></div>
                            <div style="font-size:12px; color:#909399; display: flex; align-items: center; gap: 4px;"><el-icon><Cpu /></el-icon> {{task.model}}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="center-panel">
                <el-tabs v-model="activeTab" type="card" closable @tab-remove="removeTab" v-if="tabs.length > 0">
                    <el-tab-pane v-for="item in tabs" :key="item.name" :label="item.title" :name="item.name">
                        <div class="log-container" :ref="'logBox-' + item.name">
                            <div v-for="(log, idx) in item.logs" :key="idx">
                                <div v-if="log.type === 'header'" class="log-item" style="background:#f0f9eb; padding:10px; border-radius:6px; margin-bottom:20px; border-left:4px solid #67C23A;"><div style="white-space: pre-wrap;">{{ log.content }}</div></div>
                                <div v-if="log.type === 'reasoning'" class="log-item log-reasoning"><div><b>ğŸ§  æ€è€ƒ:</b></div>{{ log.content }}</div>
                                <div v-if="log.type === 'tool_call'" class="log-item log-tool-call"><b>ğŸ”¨ è°ƒç”¨:</b> {{ log.content }}</div>
                                <div v-if="log.type === 'tool_result'" class="log-item log-tool-result"><b>ğŸ“¥ è¿”å›:</b> <div style="margin-top:4px;">{{ log.content }}</div></div>
                                <div v-if="log.type === 'response'" class="log-item log-response"><div v-html="renderMarkdown(log.content)"></div></div>
                                <div v-if="log.type === 'error'" class="log-item log-error" style="color:#F56C6C;">âŒ {{ log.content }}</div>
                                <div v-if="log.type === 'footer'" class="log-item" style="border-top:1px dashed #ccc; padding-top:10px; color:#999;"><div style="white-space: pre-wrap;">{{ log.content }}</div></div>
                            </div>
                            <div v-if="item.logs.length === 0" style="text-align:center; padding: 40px; color:#c0c4cc;"><el-icon class="is-loading" size="20"><Loading /></el-icon><div style="margin-top: 10px;">ç­‰å¾…æ—¥å¿—...</div></div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
                <div v-else style="height: 100%; display: flex; align-items: center; justify-content: center; color: #aeb4c0; flex-direction: column; gap: 16px;"><el-icon size="40" color="#dcdfe6"><Monitor /></el-icon><p style="font-weight: 500;">åŒå‡»å·¦ä¾§ä»»åŠ¡ä»¥æŸ¥çœ‹å®æ—¶æ—¥å¿—</p></div>
            </div>

            <div class="right-panel">
                <div class="panel-card" style="height: 40%;">
                    <div class="panel-header"><span>æ¨¡å‹æ± </span><el-button type="primary" circle size="small" @click.stop="addModelVisible = true" style="box-shadow: 0 2px 6px rgba(64, 158, 255, 0.3);"><el-icon><Plus /></el-icon></el-button></div>
                    <div class="scrollable-content">
                        <div v-for="m in modelList" :key="m.name" class="model-item-wrapper" @click.stop="toggleModelSlide(m.name)">
                            <div class="model-content" :class="{ 'is-slid': openedModel === m.name }">
                                <div style="display:flex; justify-content:space-between;"><span style="font-weight: 600;">{{m.name}}</span><el-tag size="small" :type="m.state === 'idle' ? 'info' : 'warning'" effect="dark" round>{{m.state}}</el-tag></div>
                            </div>
                            <div class="model-delete-btn" @click.stop="deleteModel(m.name)"><el-icon size="20"><Close /></el-icon></div>
                        </div>
                        <div v-if="modelList.length === 0" style="text-align:center; color:#ccc; padding:20px; font-size:12px;">æš‚æ— æ¨¡å‹ï¼Œè¯·æ·»åŠ </div>
                    </div>
                </div>
                <div class="panel-card" style="height: 30%;">
                    <div class="panel-header">è°ƒç”¨æ ˆ</div>
                    <div class="scrollable-content">
                        <div v-for="(t, i) in toolList" :key="i" class="list-item" style="cursor: default;"><div style="color: var(--primary-color); font-family: monospace; font-weight: 600;">{{t.tool_name}}</div><div style="color: #909399; font-size: 12px; margin-top: 4px;">From: {{truncate(t.task_name, 20)}}</div></div>
                    </div>
                </div>
                <div class="panel-card" style="flex:1;">
                    <div class="panel-header"><span>æ’ä»¶åº“</span><el-button type="primary" circle size="small" @click.stop="openUploadDialog" style="box-shadow: 0 2px 6px rgba(64, 158, 255, 0.3);"><el-icon><Plus /></el-icon></el-button></div>
                    <div class="scrollable-content">
                        <div v-for="p in plugins" :key="p.name" class="list-item" style="display:flex; justify-content:space-between; align-items: center; cursor: default;">
                            <div style="display: flex; flex-direction: column;"><span style="font-weight: 600; color: #333; font-family: monospace; font-size: 14px;">{{p.name}}</span><span style="font-size: 12px; color: #909399; margin-top: 2px;">{{truncate(p.desc, 15)}}</span></div>
                            <div class="plugin-more-btn" @click.stop="openPluginDetail(p)"><el-icon><More-Filled /></el-icon></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <el-dialog v-model="dialogVisible" title="æ–°å»ºä»»åŠ¡" width="800px" align-center style="border-radius: 12px;" @opened="initToolSelection" :close-on-click-modal="!isUploading">
            <div class="task-dialog-layout">
                <div class="task-form-col">
                    <div><div style="margin-bottom:6px; font-weight:500;">ä»»åŠ¡åç§°</div><el-input v-model="newTask.name" placeholder="ç®€çŸ­æè¿°" :disabled="isUploading"></el-input></div>

                    <div style="flex:1; display:flex; flex-direction:column;">
                        <div style="margin-bottom:6px; font-weight:500; display:flex; justify-content:space-between; align-items:center;">
                            <span>ä»»åŠ¡æŒ‡ä»¤</span>
                            <el-tooltip content="æ·»åŠ é™„ä»¶ (æ”¯æŒå›¾ç‰‡ã€PDFã€æ™®é€šæ–‡æœ¬ï¼Œæœ€å¤§10MB)" placement="top">
                                <div class="upload-trigger-btn" :class="{ 'is-disabled': isUploading }" @click="triggerAttachmentUpload">
                                    <el-icon v-if="isUploading" class="is-loading" size="18"><Loading /></el-icon>
                                    <el-icon v-else size="18"><Paperclip /></el-icon>
                                </div>
                            </el-tooltip>
                        </div>
                        <el-input type="textarea" v-model="newTask.content" style="flex:1;" :rows="8" resize="none" placeholder="åœ¨è¿™é‡Œè¾“å…¥æŒ‡ä»¤..." :disabled="isUploading"></el-input>

                        <div class="attachment-list" v-if="attachmentList.length > 0">
                            <div v-for="(file, index) in attachmentList" :key="index" class="attachment-tag">
                                <el-icon><Document /></el-icon>
                                <span>{{ truncate(file.name, 20) }}</span>
                                <span class="attachment-remove" @click="removeAttachment(index)">
                                    <el-icon size="10"><Close /></el-icon>
                                </span>
                            </div>
                        </div>
                        <input
                            type="file"
                            ref="attachmentInput"
                            @change="handleAttachmentUpload"
                            style="display: none"
                            accept=".jpg,.jpeg,.png,.webp,.gif,.bmp,.tiff,.pdf,.mp4,.mkv,.mov,.avi,.webm,.mp3,.wav,.aac,.flac,.m4a,.ogg"
                        >
                    </div>

                    <div><div style="margin-bottom:6px; font-weight:500;">æ‰§è¡Œæ¨¡å‹</div><el-select v-model="newTask.model" style="width:100%" placeholder="è¯·é€‰æ‹©æ¨¡å‹" :disabled="isUploading"><el-option v-for="m in modelList" :key="m.name" :label="m.name" :value="m.name"></el-option></el-select></div>
                </div>
                <div class="task-tool-col">
                    <div class="tool-tree-header"><span>å¯ç”¨å·¥å…·é€‰æ‹©</span><el-tag size="small" type="success" effect="plain">{{ computedSelectedCount }} é¡¹å·²é€‰</el-tag></div>
                    <div class="tool-tree-container">
                        <div v-for="(pVal, pName) in toolSelection" :key="pName" class="plugin-node">
                            <div class="plugin-node-header">
                                <el-checkbox v-model="pVal.checked" :indeterminate="pVal.indeterminate" @change="(val) => handlePluginCheck(pName, val)" :disabled="isUploading"><span class="plugin-checkbox">{{ pName }}</span></el-checkbox>
                                <div class="toggle-btn" :class="{'is-open': pVal.expanded}" @click="pVal.expanded = !pVal.expanded"><el-icon><Arrow-Down /></el-icon></div>
                            </div>
                            <div class="func-node-list" v-show="pVal.expanded">
                                <el-checkbox v-for="func in pVal.functions" :key="func.value" v-model="func.checked" class="func-checkbox" @change="handleFuncCheck(pName)" :disabled="isUploading">{{ func.name }}</el-checkbox>
                                <div v-if="!pVal.functions || pVal.functions.length === 0" style="color:#ccc; font-size:12px;">æ— å¯¼å‡ºå‡½æ•°</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <template #footer>
                <el-button @click="dialogVisible = false" :disabled="isUploading">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="submitTask" :loading="isUploading" :disabled="isUploading">
                    {{ isUploading ? 'ä¸Šä¼ é™„ä»¶ä¸­...' : 'æäº¤æ‰§è¡Œ' }}
                </el-button>
            </template>
        </el-dialog>

        <el-dialog v-model="addModelVisible" title="æ·»åŠ æ–°æ¨¡å‹" width="450px" align-center style="border-radius: 12px;">
            <el-form :model="newModel" label-position="top">
                <el-form-item label="æ¨¡å‹åç§° (Model Name)" required><el-input v-model="newModel.model_name" placeholder="e.g. gpt-4o"></el-input></el-form-item>
                <el-form-item label="Base URL" required><el-input v-model="newModel.base_url" placeholder="e.g. https://api.openai.com/v1"></el-input></el-form-item>
                <el-form-item label="API Key" required><el-input v-model="newModel.api_key" show-password placeholder="sk-..."></el-input></el-form-item>
            </el-form>
            <template #footer><el-button @click="addModelVisible = false">å–æ¶ˆ</el-button><el-button type="primary" @click="submitNewModel">ä¿å­˜æ¨¡å‹</el-button></template>
        </el-dialog>

        <el-dialog v-model="pluginDetailVisible" :title="currentPlugin ? currentPlugin.name + ' è¯¦æƒ…' : 'æ’ä»¶è¯¦æƒ…'" width="550px" align-center>
            <div v-if="currentPlugin" style="max-height: 500px; overflow-y: auto;">
                <div style="background: #fdf6ec; color: #e6a23c; padding: 10px; border-radius: 6px; font-size: 13px; margin-bottom: 20px;"><el-icon><Info-Filled /></el-icon> {{ currentPlugin.desc }}</div>
                <h4 style="margin: 0 0 10px 0; color: #303133;">åŒ…å«å‡½æ•°</h4>
                <div v-if="currentPlugin.functions && Object.keys(currentPlugin.functions).length > 0">
                    <div v-for="(funcConfig, funcKey) in currentPlugin.functions" :key="funcKey" class="func-item">
                        <div class="func-name">{{ funcKey }}</div>
                        <div class="func-desc">{{ funcConfig.function?.description || 'æš‚æ— æè¿°' }}</div>
                        <div v-if="funcConfig.function?.parameters?.properties">
                            <span v-for="(propVal, propKey) in funcConfig.function.parameters.properties" :key="propKey" class="param-tag" :class="isParamRequired(funcConfig, propKey) ? 'is-required' : 'is-optional'">
                                {{ propKey }}<span v-if="isParamRequired(funcConfig, propKey)" style="margin-left:2px;">*</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div v-else style="text-align: center; color: #999; padding: 20px;">è¯¥æ’ä»¶æœªå¯¼å‡ºä»»ä½•å‡½æ•°</div>
                <div style="margin-top: 30px; border-top: 1px dashed #eee; padding-top: 20px;"><el-button type="danger" plain style="width: 100%;" @click="requestUnregister(currentPlugin.name)"><el-icon style="margin-right: 5px;"><Delete /></el-icon> æ³¨é”€æ­¤æ’ä»¶</el-button></div>
            </div>
        </el-dialog>

        <el-dialog v-model="deleteDialogVisible" title="å±é™©æ“ä½œ" width="400px" align-center>
             <div style="display: flex; gap: 15px;"><el-icon color="#F56C6C" size="24"><Warning-Filled /></el-icon><div><div style="font-weight: 600; margin-bottom: 6px;">ç¡®å®šæ³¨é”€ {{ targetPlugin }} ï¼Ÿ</div><el-checkbox v-model="deleteSourceChecked" label="åŒæ—¶åˆ é™¤æºæ–‡ä»¶" style="color: #F56C6C;"></el-checkbox></div></div>
            <template #footer><el-button @click="deleteDialogVisible = false">å–æ¶ˆ</el-button><el-button type="danger" @click="confirmUnregister" :loading="deleting">ç¡®è®¤æ³¨é”€</el-button></template>
        </el-dialog>

        <el-dialog v-model="uploadDialogVisible" title="å®‰è£…æ–°æ’ä»¶" width="500px" align-center>
            <div class="upload-drop-zone" :class="{ 'is-dragging': isDragging }" @click="triggerFileSelect" @dragover.prevent @dragenter.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop">
                <el-icon class="upload-icon"><Upload-Filled /></el-icon><div class="upload-text">æ‹–æ‹½ .zip åŒ…è‡³æ­¤ï¼Œæˆ– <em>ç‚¹å‡»ä¸Šä¼ </em></div>
            </div>
            <div class="upload-tips"><div style="font-weight: 600; margin-bottom: 6px; color: #F56C6C;">æ’ä»¶åŒ…ç»“æ„è¦æ±‚ï¼š</div><ul><li>å¿…é¡»åŒ…å« <code>__init__.py</code></li><li>å¿…é¡»åŒ…å«åŒå <code>.yaml</code></li></ul></div>
            <input type="file" ref="fileInput" @change="handleFileUpload" style="display: none" accept=".zip">
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick, computed } = Vue;
        const { ElMessage } = ElementPlus;

        const app = createApp({
            setup() {
                const currentTime = ref('');
                const taskList = ref([]);
                const modelList = ref([]);
                const toolList = ref([]);
                const plugins = ref([]);

                const dialogVisible = ref(false);
                const pluginDetailVisible = ref(false);
                const currentPlugin = ref(null);
                const deleteDialogVisible = ref(false);
                const targetPlugin = ref("");
                const deleteSourceChecked = ref(false);
                const deleting = ref(false);
                const fileInput = ref(null);
                const uploadDialogVisible = ref(false);
                const isDragging = ref(false);
                const activeTab = ref(null);
                const tabs = ref([]);

                const newTask = ref({ name: "", content: "", tools: [], model: "", file_paths: [] });
                const toolSelection = ref({});
                const addModelVisible = ref(false);
                const newModel = ref({ model_name: "", base_url: "", api_key: "" });
                const openedModel = ref(null);

                const attachmentList = ref([]);
                const attachmentInput = ref(null);
                const isUploading = ref(false);
                const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

                setInterval(() => { currentTime.value = new Date().toLocaleTimeString(); }, 1000);

                const fetchData = async () => {
                    try {
                        const res = await axios.get('/api/dashboard');
                        taskList.value = res.data.tasks;
                        modelList.value = res.data.models;
                        toolList.value = res.data.tools;
                        tabs.value.forEach(async (tab) => {
                            try {
                                const logRes = await axios.get(`/api/logs/${tab.name}`);
                                if (logRes.data && logRes.data.length > tab.logs.length) {
                                    tab.logs = logRes.data;
                                    if(activeTab.value === tab.name) nextTick(() => { const el = document.querySelector('.el-tab-pane[style*="display: block"] .log-container'); if(el) el.scrollTop = el.scrollHeight; });
                                }
                            } catch(e) {}
                        });
                    } catch (e) {}
                };

                const fetchExtras = async () => {
                    try { const res = await axios.get('/api/plugins'); plugins.value = res.data; } catch(e) {}
                };

                const initToolSelection = () => {
                    fetchExtras().then(() => {
                        const defaultSelection = [];
                        const state = {};
                        plugins.value.forEach(p => {
                            const pName = p.name;
                            const funcsObj = JSON.parse(JSON.stringify(p.functions || {}));
                            const funcs = Object.keys(funcsObj).map(fName => ({ name: fName, value: `${pName}/${fName}`, checked: true }));
                            state[pName] = { checked: false, indeterminate: false, expanded: true, functions: funcs };
                            if(defaultSelection.includes(pName)) { state[pName].checked = true; funcs.forEach(f => f.checked = true); }
                            else { state[pName].checked = false; funcs.forEach(f => f.checked = false); }
                        });
                        toolSelection.value = state;
                    });
                };

                const renderMarkdown = (t) => {
                    if (!t) return '';
                    return marked.parse(t, { breaks: true, gfm: true });
                };

                const isParamRequired = (funcConfig, key) => { const req = funcConfig.function?.parameters?.required || []; return req.includes(key); };
                const handlePluginCheck = (pName, val) => { const node = toolSelection.value[pName]; node.indeterminate = false; node.functions.forEach(f => f.checked = val); };
                const handleFuncCheck = (pName) => { const node = toolSelection.value[pName]; const total = node.functions.length; const checkedCount = node.functions.filter(f => f.checked).length; node.checked = checkedCount === total && total > 0; node.indeterminate = checkedCount > 0 && checkedCount < total; };
                const computedSelectedCount = computed(() => { let count = 0; Object.values(toolSelection.value).forEach(p => count += p.functions.filter(f => f.checked).length); return count; });

                const showAddDialog = () => { fetchExtras(); dialogVisible.value = true; if(modelList.value.length > 0) newTask.value.model = modelList.value[0].name; else newTask.value.model = ""; attachmentList.value = []; };

                const triggerAttachmentUpload = () => {
                    if (isUploading.value) return;
                    attachmentInput.value.click();
                };

                const handleAttachmentUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > MAX_FILE_SIZE) {
                        ElMessage.warning(`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ ${MAX_FILE_SIZE / 1024 / 1024}MB`);
                        e.target.value = '';
                        return;
                    }

                    isUploading.value = true;
                    const fd = new FormData();
                    fd.append('file', file);

                    try {
                        const res = await axios.post('/api/attachments/upload', fd);
                        if (res.data.status === 'success') {
                            attachmentList.value.push({
                                name: res.data.filename,
                                path: res.data.file_path
                            });
                            ElMessage.success("é™„ä»¶ä¸Šä¼ æˆåŠŸ");
                        }
                    } catch (error) {
                        ElMessage.error("é™„ä»¶ä¸Šä¼ å¤±è´¥: " + (error.response?.data?.detail || "ç½‘ç»œé”™è¯¯"));
                    } finally {
                        isUploading.value = false;
                        e.target.value = '';
                    }
                };

                const removeAttachment = (index) => { attachmentList.value.splice(index, 1); };

                const submitTask = async () => {
                    if (isUploading.value) {
                        ElMessage.warning("è¯·ç­‰å¾…é™„ä»¶ä¸Šä¼ å®Œæˆ");
                        return;
                    }

                    const finalTools = [];
                    Object.entries(toolSelection.value).forEach(([pName, node]) => { if (node.checked) finalTools.push(pName); else node.functions.forEach(f => { if(f.checked) finalTools.push(f.value); }); });
                    newTask.value.tools = finalTools;
                    newTask.value.file_paths = attachmentList.value.map(item => item.path);

                    try {
                        // [å…³é”®ä¿®å¤] æ·»åŠ  const res = ...
                        const res = await axios.post('/api/tasks', newTask.value);
                        ElMessage.success("å·²æäº¤");
                        dialogVisible.value = false;
                        fetchData();
                        openTaskTab({ task_id: res.data.task_id, task_name: newTask.value.name });

                        const defaultModel = modelList.value.length > 0 ? modelList.value[0].name : "";
                        newTask.value = { name: "", content: "", tools: [], model: defaultModel, file_paths: [] };
                        attachmentList.value = [];
                    } catch(e) { ElMessage.error("å¤±è´¥: " + e.message); }
                };

                const submitNewModel = async () => { const name = newModel.value.model_name; if(!name || !newModel.value.base_url || !newModel.value.api_key) { ElMessage.warning("æ‰€æœ‰å­—æ®µå‡ä¸ºå¿…å¡«é¡¹"); return; } const exists = modelList.value.some(m => m.name === name); if (exists) { ElMessage.warning(`æ¨¡å‹ "${name}" å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ `); return; } try { await axios.post('/api/models', newModel.value); ElMessage.success(`æ¨¡å‹ ${name} å·²æ·»åŠ `); addModelVisible.value = false; newModel.value = { model_name: "", base_url: "", api_key: "" }; fetchData(); } catch(e) { ElMessage.error("æ·»åŠ å¤±è´¥: " + (e.response?.data?.detail || e.message)); } };
                const toggleModelSlide = (name) => { if (openedModel.value === name) openedModel.value = null; else openedModel.value = name; };
                const handleGlobalClick = () => { if (openedModel.value) openedModel.value = null; };
                const deleteModel = async (name) => { try { await axios.delete(`/api/models/${encodeURIComponent(name)}`); ElMessage.success(`æ¨¡å‹ ${name} å·²åˆ é™¤`); openedModel.value = null; fetchData(); } catch(e) { ElMessage.error("åˆ é™¤å¤±è´¥"); } };
                const openUploadDialog = () => { uploadDialogVisible.value = true; };
                const triggerFileSelect = () => { fileInput.value.click(); };
                const processUpload = async (file) => { if (!file.name.endsWith('.zip')) { ElMessage.warning("è¯·ä¸Šä¼  .zip æ ¼å¼æ–‡ä»¶"); return; } const fd = new FormData(); fd.append('file', file); try { await axios.post('/api/plugins/upload', fd); ElMessage.success("å®‰è£…æˆåŠŸ"); uploadDialogVisible.value = false; fetchExtras(); } catch(e) { ElMessage.error("å®‰è£…å¤±è´¥"); } };
                const handleDrop = (e) => { isDragging.value = false; const files = e.dataTransfer.files; if (files.length > 0) processUpload(files[0]); };
                const handleFileUpload = (e) => { const file = e.target.files[0]; if(file) processUpload(file); e.target.value = ''; };
                const openPluginDetail = (p) => { currentPlugin.value = JSON.parse(JSON.stringify(p)); pluginDetailVisible.value = true; };
                const requestUnregister = (name) => { pluginDetailVisible.value = false; targetPlugin.value = name; deleteSourceChecked.value = false; deleteDialogVisible.value = true; };
                const confirmUnregister = async () => { deleting.value = true; try { await axios.post('/api/plugins/unregister', { plugin_name: targetPlugin.value, delete_source: deleteSourceChecked.value }); ElMessage.success("å·²æ³¨é”€"); deleteDialogVisible.value = false; fetchExtras(); } catch(e) { ElMessage.error("å¤±è´¥"); } finally { deleting.value = false; } };
                const openTaskTab = (task) => { const existing = tabs.value.find(t => t.name === task.task_id); if(existing) activeTab.value = task.task_id; else { tabs.value.push({ title: task.task_name, name: task.task_id, logs: [] }); activeTab.value = task.task_id; } };
                const removeTab = (n) => { tabs.value = tabs.value.filter(t => t.name !== n); if(activeTab.value === n) activeTab.value = tabs.value.length ? tabs.value[0].name : null; };
                const openTaskByModel = (m) => { if(m.task_id) openTaskTab({task_id: m.task_id, task_name: m.task_name}); };
                const truncate = (s, l) => s && s.length > l ? s.substring(0,l)+'...' : s;

                onMounted(() => { fetchData(); fetchExtras(); setInterval(fetchData, 1000); });

                return {
                    currentTime, taskList, modelList, toolList, plugins,
                    dialogVisible, newTask, fileInput, activeTab, tabs,
                    pluginDetailVisible, currentPlugin, deleteDialogVisible, targetPlugin, deleteSourceChecked, deleting,
                    toolSelection, computedSelectedCount, uploadDialogVisible, isDragging,
                    openTaskTab, removeTab, renderMarkdown, openTaskByModel, submitTask, showAddDialog, truncate,
                    openPluginDetail, requestUnregister, confirmUnregister,
                    handlePluginCheck, handleFuncCheck, initToolSelection,
                    openUploadDialog, triggerFileSelect, handleDrop, handleFileUpload,
                    addModelVisible, newModel, submitNewModel, isParamRequired,
                    openedModel, toggleModelSlide, handleGlobalClick, deleteModel,
                    attachmentInput, attachmentList, triggerAttachmentUpload, handleAttachmentUpload, removeAttachment, isUploading
                };
            }
        });
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) app.component(key, component);
        app.use(ElementPlus); app.mount('#app');
    </script>
</body>
</html>